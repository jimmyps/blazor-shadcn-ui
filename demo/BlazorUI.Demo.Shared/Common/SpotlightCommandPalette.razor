@using BlazorUI.Components.Command
@using BlazorUI.Components.Dialog
@using BlazorUI.Components.HeightAnimation
@using BlazorUI.Demo.Services
@using BlazorUI.Icons.Feather.Data
@using BlazorUI.Icons.Heroicons.Data
@using Microsoft.AspNetCore.Components
@inject KeyboardShortcutService KeyboardShortcuts
@inject NavigationManager NavigationManager
@implements IAsyncDisposable

@* Spotlight Command Palette - Global search and command interface *@
<Dialog @bind-Open="_isOpen">
    <DialogContent 
        ShowClose="false" UseCustomAnimations="true"
        Class="max-w-lg border-border/40 p-0 rounded-2xl shadow-xl gap-0 overflow-hidden top-[20vh] duration-500 translate-y-0 dialog-panel dialog-animated"
        OverlayClass="!bg-background/70 backdrop-blur backdrop-saturate-150 dialog-overlay dialog-animated">
        
        <HeightAnimation Config="@_heightAnimationConfig" Enabled="@_isOpen">
            <BlazorUI.Components.Command.Command OnValueChange="@HandleSelect">
                <CommandInput 
                    Placeholder="Type a command or search..." SearchInterval="300" AutoFocus="true"
                    Class="border-0 border-b border-border/40 rounded-none focus-visible:ring-0" />
                
                <CommandList Class="max-h-[350px] scrollbar-thin">
                    <CommandEmpty>
                        <div class="flex flex-col items-center gap-2 py-6 text-muted-foreground">
                            <LucideIcon Name="search-x" Size="32" />
                            <p class="text-sm">No results found.</p>
                        </div>
                    </CommandEmpty>
                    
                    <CommandGroup Heading="Navigation">
                        <CommandItem Value="">
                            <LucideIcon Name="house" Size="16" Class="mr-2" />
                            <span>Home</span>
                        </CommandItem>
                        <CommandItem Value="components">
                            <LucideIcon Name="layout-grid" Size="16" Class="mr-2" />
                            <span>Components</span>
                        </CommandItem>
                        <CommandItem Value="primitives">
                            <LucideIcon Name="box" Size="16" Class="mr-2" />
                            <span>Primitives</span>
                        </CommandItem>
                        <CommandItem Value="architecture">
                            <LucideIcon Name="git-branch" Size="16" Class="mr-2" />
                            <span>Architecture</span>
                        </CommandItem>
                    </CommandGroup>
                    
                    <CommandSeparator />

                    <CommandVirtualizedGroup TItem="ComponentItem"
                            Heading="Components"
                            Items="Components"
                            ItemValue="@(item => item.Value)"
                            ItemSearchText="@(item => item.Name)"
                            MaxDisplayCount="0">
                        <ItemTemplate Context="item">
                            <LucideIcon Name="@item.Icon" Size="16" Class="mr-2 text-primary" />
                            @item.Name
                            <span class="ml-auto text-xs text-muted-foreground">Styled</span>
                        </ItemTemplate>
                    </CommandVirtualizedGroup>
                    
                    <CommandSeparator />

                    <CommandVirtualizedGroup TItem="ComponentItem"
                            Heading="Primitives"
                            Items="Primitives"
                            ItemValue="@(item => item.Value)"
                            ItemSearchText="@(item => item.Name)"
                            MaxDisplayCount="0">
                        <ItemTemplate Context="item">
                            <LucideIcon Name="@item.Icon" Size="16" Class="mr-2 text-muted-foreground" />
                            @item.Name
                            <span class="ml-auto text-xs text-muted-foreground">Headless</span>
                        </ItemTemplate>
                    </CommandVirtualizedGroup>

                    <CommandVirtualizedGroup TItem="string"
                        Heading="Lucide Icons"
                        Items="AllLucideIcons"
                        ItemValue="@(name => $"/icons/lucide?search={name}")"
                        ItemSearchText="@(name => name)"
                        MaxDisplayCount="0"
                        EnableLazyLoading="true">
                        <ItemTemplate Context="iconName">
                            <LucideIcon Name="@iconName" Size="16" Class="mr-2 text-blue-500" />
                            @FormatIconName(iconName)
                            <span class="ml-auto text-xs text-muted-foreground">Lucide</span>
                        </ItemTemplate>
                    </CommandVirtualizedGroup>

                    <CommandSeparator />

                    <CommandVirtualizedGroup TItem="string"
                        Heading="Heroicons"
                        Items="AllHeroIcons"
                        ItemValue="@(name => $"/icons/heroicons?search={name}")"
                        ItemSearchText="@(name => name)"
                        MaxDisplayCount="0"
                        EnableLazyLoading="true">
                        <ItemTemplate Context="iconName">
                            <HeroIcon Name="@iconName" Size="16" Class="mr-2 text-indigo-500" />
                            @FormatIconName(iconName)
                            <span class="ml-auto text-xs text-muted-foreground">Heroicons</span>
                        </ItemTemplate>
                    </CommandVirtualizedGroup>

                    <CommandSeparator />

                    <CommandVirtualizedGroup TItem="string"
                        Heading="Feather Icons"
                        Items="AllFeatherIcons"
                        ItemValue="@(name => $"/icons/feather?search={name}")"
                        ItemSearchText="@(name => name)"
                        MaxDisplayCount="0"
                        EnableLazyLoading="true">
                        <ItemTemplate Context="iconName">
                            <FeatherIcon Name="@iconName" Size="16" Class="mr-2 text-cyan-500" />
                            @FormatIconName(iconName)
                            <span class="ml-auto text-xs text-muted-foreground">Feather</span>
                        </ItemTemplate>
                    </CommandVirtualizedGroup>

                </CommandList>
            </BlazorUI.Components.Command.Command>
        </HeightAnimation>
    </DialogContent>
</Dialog>

@code {
    private bool _isOpen = false;
    private readonly HeightAnimationConfig _heightAnimationConfig = new()
    {
        ContentSelector = "[role=\"listbox\"]",
        InputSelector = "[data-command-input-wrapper]",
        IncludeInputHeight = true
    };

    /// <summary>
    /// Opens the spotlight command palette.
    /// </summary>
    public void Open()
    {
        _isOpen = true;
        StateHasChanged();
    }

    /// <summary>
    /// Closes the spotlight command palette.
    /// </summary>
    public void Close()
    {
        _isOpen = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Initialize keyboard shortcuts
            await KeyboardShortcuts.InitializeAsync();
            KeyboardShortcuts.RegisterShortcut("k", async () =>
            {
                _isOpen = !_isOpen;
                await InvokeAsync(StateHasChanged);
            });
        }
    }

    private void HandleSelect(string value)
    {
        _isOpen = false;
        
        // Navigate based on the selected value
        NavigationManager.NavigateTo(value);
    }

    private static string FormatIconName(string iconName)
    {
        return string.Join(" ", iconName.Split('-').Select(word =>
            char.ToUpper(word[0]) + word.Substring(1)));
    }
    
    // Component data structure
    private record ComponentItem(string Name, string Value, string Icon);
    
    // List of all components
    private readonly List<ComponentItem> Components = new()
    {
        new("Accordion", "components/accordion", "chevrons-down-up"),
        new("Alert", "components/alert", "circle-alert"),
        new("Alert Dialog", "components/alert-dialog", "triangle-alert"),
        new("Aspect Ratio", "components/aspectratio", "square"),
        new("Avatar", "components/avatar", "user"),
        new("Badge", "components/badge", "award"),
        new("Breadcrumb", "components/breadcrumb", "chevron-right"),
        new("Button", "components/button", "pointer"),
        new("Button Group", "components/button-group", "boxes"),
        new("Calendar", "components/calendar", "calendar"),
        new("Card", "components/card", "credit-card"),
        new("Carousel", "components/carousel", "images"),
        new("Chart", "components/chart", "area-chart"),
        new("Checkbox", "components/checkbox", "square-check"),
        new("Collapsible", "components/collapsible", "circle-chevron-down"),
        new("Combobox", "components/combobox", "square-chevron-down"),
        new("Command", "components/command", "terminal"),
        new("Context Menu", "components/context-menu", "menu"),
        new("Data Table", "components/datatable", "table"),
        new("Date Picker", "components/date-picker", "calendar-days"),
        new("Dialog", "components/dialog", "square"),
        new("Dialog Service", "components/dialog-service", "square-check-big"),
        new("Dropdown Menu", "components/dropdown-menu", "panel-top-open"),
        new("Empty", "components/empty", "inbox"),
        new("Field", "components/field", "text"),
        new("Grid", "components/grid", "table-2"),
        new("Hover Card", "components/hovercard", "square-mouse-pointer"),
        new("Input", "components/input", "type"),
        new("Input Group", "components/input-group", "blocks"),
        new("Input OTP", "components/input-otp", "shield-check"),
        new("Item", "components/item", "circle"),
        new("Kbd", "components/kbd", "keyboard"),
        new("Label", "components/label", "tag"),
        new("Link Button", "components/button#linkbutton", "link"),
        new("Markdown Editor", "components/markdown-editor", "file-text"),
        new("Menubar", "components/menubar", "square-menu"),
        new("Motion", "components/motion", "zap"),
        new("Multi Select", "components/multiselect", "list-checks"),
        new("Native Select", "components/native-select", "chevrons-up-down"),
        new("Navigation Menu", "components/navigation-menu", "compass"),
        new("Pagination", "components/pagination", "chevrons-left-right"),
        new("Popover", "components/popover", "message-square"),
        new("Progress", "components/progress", "loader"),
        new("Radio Group", "components/radio-group", "circle-dot"),
        new("Resizable", "components/resizable", "panel-left"),
        new("Rich Text Editor", "components/rich-text-editor", "type"),
        new("Scroll Area", "components/scroll-area", "scroll-text"),
        new("Select", "components/select", "list"),
        new("Separator", "components/separator", "minus"),
        new("Sheet", "components/sheet", "panel-right"),
        new("Sidebar", "components/sidebar", "panel-left"),
        new("Skeleton", "components/skeleton", "box"),
        new("Slider", "components/slider", "sliders-horizontal"),
        new("Spinner", "components/spinner", "loader-circle"),
        new("Switch", "components/switch", "toggle-left"),
        new("Tabs", "components/tabs", "folder"),
        new("Textarea", "components/textarea", "text-cursor-input"),
        new("Time Picker", "components/time-picker", "clock"),
        new("Toast", "components/toast", "bell"),
        new("Toggle", "components/toggle", "toggle-right"),
        new("Toggle Group", "components/toggle-group", "boxes"),
        new("Tooltip", "components/tooltip", "message-circle"),
        new("Typography", "components/typography", "heading"),
    };
    
    // List of all primitives
    private readonly List<ComponentItem> Primitives = new()
    {
        new("Accordion", "primitives/accordion", "chevrons-down-up"),
        new("Checkbox", "primitives/checkbox", "square-check"),
        new("Collapsible", "primitives/collapsible", "chevron-down"),
        new("Combobox", "primitives/combobox", "square-chevron-down"),
        new("Dialog", "primitives/dialog", "square"),
        new("Dropdown Menu", "primitives/dropdown-menu", "chevron-down"),
        new("Hover Card", "primitives/hovercard", "square-mouse-pointer"),
        new("Label", "primitives/label", "tag"),
        new("Popover", "primitives/popover", "message-square"),
        new("Radio Group", "primitives/radio-group", "circle-dot"),
        new("Select", "primitives/select", "list"),
        new("Sheet", "primitives/sheet", "panel-right"),
        new("Switch", "primitives/switch", "toggle-left"),
        new("Table", "primitives/table", "table"),
        new("Tabs", "primitives/tabs", "folder"),
        new("Tooltip", "primitives/tooltip", "message-circle"),
    };

    private static readonly string[] AllLucideIcons = LucideIconData.GetAvailableIcons().OrderBy(x => x).ToArray();
    private static readonly string[] AllHeroIcons = HeroIconData.GetAvailableIcons(HeroIconVariant.Outline).OrderBy(x => x).ToArray();
    private static readonly string[] AllFeatherIcons = FeatherIconData.GetAvailableIcons().OrderBy(x => x).ToArray();

    public async ValueTask DisposeAsync()
    {
        if (KeyboardShortcuts != null)
        {
            try
            {
                KeyboardShortcuts.UnregisterShortcut("k");
            }
            catch (ObjectDisposedException)
            {
                // Service already disposed, ignore
            }
            catch (InvalidOperationException)
            {
                // Shortcut not registered or already removed, ignore
            }
        }
    }
}

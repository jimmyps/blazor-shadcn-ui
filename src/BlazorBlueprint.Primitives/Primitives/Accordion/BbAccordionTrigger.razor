@namespace BlazorBlueprint.Primitives.Accordion

@* AccordionTrigger primitive - clickable trigger button for accordion item *@
@HeadingFragment

@code {
    private string _ariaExpanded => Item.IsOpen ? "true" : "false";

    /// <summary>
    /// Cascading parameter to receive the parent accordion item.
    /// </summary>
    [CascadingParameter]
    public BbAccordionItem Item { get; set; } = null!;

    /// <summary>
    /// The child content to render within the trigger button.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// CSS classes to apply to the trigger button element.
    /// </summary>
    [Parameter]
    public string? Class { get; set; }

    /// <summary>
    /// Additional attributes to apply to the trigger button element.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    /// <summary>
    /// The HTML element tag to use for the heading wrapper.
    /// Default is "h3".
    /// </summary>
    [Parameter]
    public string As { get; set; } = "h3";

    private RenderFragment HeadingFragment => builder =>
    {
        builder.OpenElement(0, As);
        builder.AddAttribute(1, "id", Item.HeaderId);
        builder.AddContent(2, ButtonContent);
        builder.CloseElement();
    };

    private RenderFragment ButtonContent => __builder =>
    {
        <button id="@Item.TriggerId"
                type="button"
                class="@Class"
                aria-expanded="@_ariaExpanded"
                aria-controls="@Item.ContentId"
                data-state="@(Item.IsOpen ? "open" : "closed")"
                disabled="@Item.Disabled"
                @onclick="HandleClick"
                @onkeydown="HandleKeyDown"
                @attributes="AdditionalAttributes">
            @ChildContent
        </button>
    };

    protected override void OnInitialized()
    {
        if (Item == null)
        {
            throw new InvalidOperationException("AccordionTrigger must be used within an AccordionItem component.");
        }
    }

    private void HandleClick()
    {
        if (!Item.Disabled)
        {
            Item.Toggle();
        }
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (Item.Disabled) return;

        // Space and Enter activate the trigger
        if (e.Key == " " || e.Key == "Enter")
        {
            Item.Toggle();
        }
    }
}

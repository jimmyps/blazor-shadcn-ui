@namespace BlazorUI.Primitives.Menubar

@* MenubarSub - container for a submenu within a menubar menu *@
<CascadingValue Value="@_context" IsFixed="false">
    @ChildContent
</CascadingValue>

@code {
    private readonly MenubarSubContext _context = new();

    [CascadingParameter]
    private MenubarContext? MenuContext { get; set; }

    [CascadingParameter(Name = "ParentSubContext")]
    private MenubarSubContext? ParentSubContext { get; set; }

    /// <summary>
    /// The content to render inside the submenu.
    /// Typically contains MenubarSubTrigger and MenubarSubContent.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Controls whether the submenu is open (controlled mode).
    /// </summary>
    [Parameter]
    public bool? Open { get; set; }

    /// <summary>
    /// Event callback invoked when the open state changes.
    /// </summary>
    [Parameter]
    public EventCallback<bool> OpenChanged { get; set; }

    /// <summary>
    /// Event callback invoked when the submenu open state changes.
    /// </summary>
    [Parameter]
    public EventCallback<bool> OnOpenChange { get; set; }

    protected override void OnInitialized()
    {
        // Set depth based on parent submenu depth (for proper z-index stacking)
        // First-level submenu = depth 0, second-level = depth 1, etc.
        EnsureDepth();

        if (Open.HasValue)
        {
            _context.IsOpen = Open.Value;
        }

        _context.OnOpenChange = HandleOpenChange;
    }

    protected override void OnParametersSet()
    {
        if (Open.HasValue && _context.IsOpen != Open.Value)
        {
            _context.IsOpen = Open.Value;
        }
    }

    private void EnsureDepth()
    {
        if (ParentSubContext != null)
        {
            if (ParentSubContext.ActiveSubMenu != null)
                _context.Depth = ParentSubContext.ActiveSubMenu.Depth + 1;
            else
                _context.Depth = ParentSubContext.Depth + 1;
        }
        else
        {
            _context.Depth = 0;
        }
    }

    private async Task HandleOpenChange(bool isOpen)
    {
        EnsureDepth();

        _context.IsOpen = isOpen;

        await OpenChanged.InvokeAsync(isOpen);
        if (OnOpenChange.HasDelegate)
        {
            await OnOpenChange.InvokeAsync(isOpen);
        }
    }
}

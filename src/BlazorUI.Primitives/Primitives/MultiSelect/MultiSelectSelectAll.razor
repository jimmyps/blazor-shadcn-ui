@namespace BlazorUI.Primitives.MultiSelect
@implements IDisposable

@* MultiSelectSelectAll primitive - headless "Select All" option with indeterminate state *@
<div @ref="_element"
     role="option"
     aria-selected="@GetAriaSelected()"
     aria-disabled="@(Disabled ? "true" : "false")"
     data-state="@GetDataState()"
     data-disabled="@Disabled"
     @onclick="HandleClick"
     @onclick:stopPropagation="true"
     @attributes="AdditionalAttributes">
    @ChildContent
</div>

@code {
    [CascadingParameter]
    public MultiSelectContext Context { get; set; } = null!;

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Whether this select all option is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Callback invoked when select all is toggled.
    /// </summary>
    [Parameter]
    public EventCallback OnToggle { get; set; }

    /// <summary>
    /// Additional attributes to apply to the element.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private ElementReference _element;
    private SelectAllState _selectAllState = SelectAllState.None;

    /// <summary>
    /// Gets the current select all state.
    /// </summary>
    public SelectAllState SelectAllState => _selectAllState;

    /// <summary>
    /// Gets whether all items are selected.
    /// </summary>
    public bool IsAllSelected => _selectAllState == SelectAllState.All;

    /// <summary>
    /// Gets whether some (but not all) items are selected.
    /// </summary>
    public bool IsIndeterminate => _selectAllState == SelectAllState.Indeterminate;

    protected override void OnInitialized()
    {
        if (Context == null)
        {
            throw new InvalidOperationException($"{nameof(MultiSelectSelectAll)} must be used within a {nameof(MultiSelect)} component.");
        }

        // Subscribe to context state changes
        Context.OnStateChanged += HandleContextStateChanged;

        // Initial state
        UpdateState();
    }

    private async Task HandleClick()
    {
        if (Disabled) return;

        Context.ToggleSelectAll();

        if (OnToggle.HasDelegate)
        {
            await OnToggle.InvokeAsync();
        }
    }

    private void HandleContextStateChanged()
    {
        UpdateState();
        StateHasChanged();
    }

    private void UpdateState()
    {
        _selectAllState = Context.GetSelectAllState();
    }

    private string GetAriaSelected()
    {
        return _selectAllState switch
        {
            SelectAllState.All => "true",
            SelectAllState.Indeterminate => "mixed",
            _ => "false"
        };
    }

    private string GetDataState()
    {
        return _selectAllState switch
        {
            SelectAllState.All => "checked",
            SelectAllState.Indeterminate => "indeterminate",
            _ => "unchecked"
        };
    }

    public void Dispose()
    {
        if (Context != null)
        {
            Context.OnStateChanged -= HandleContextStateChanged;
        }
    }
}

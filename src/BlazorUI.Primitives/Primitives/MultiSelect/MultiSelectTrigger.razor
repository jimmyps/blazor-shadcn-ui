@namespace BlazorUI.Primitives.MultiSelect
@implements IDisposable

@* MultiSelectTrigger primitive - headless button that opens the multiselect dropdown *@
<button type="button"
        @ref="_buttonElement"
        id="@Context.TriggerId"
        role="combobox"
        aria-expanded="@Context.IsOpen.ToString().ToLower()"
        aria-controls="@Context.ContentId"
        aria-haspopup="listbox"
        aria-multiselectable="true"
        aria-disabled="@Context.Disabled.ToString().ToLower()"
        disabled="@Context.Disabled"
        data-state="@(Context.IsOpen ? "open" : "closed")"
        @onclick="HandleClick"
        @onkeydown="HandleKeyDown"
        @attributes="AdditionalAttributes">
    @ChildContent
</button>

@code {
    [CascadingParameter]
    public MultiSelectContext Context { get; set; } = null!;

    private ElementReference _buttonElement;

    /// <summary>
    /// Content to render inside the trigger button.
    /// Typically shows selected tags or placeholder text.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Additional attributes to be applied to the button element.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    protected override void OnInitialized()
    {
        if (Context == null)
        {
            throw new InvalidOperationException($"{nameof(MultiSelectTrigger)} must be used within a {nameof(MultiSelect)} component.");
        }

        // Subscribe to context state changes
        Context.OnStateChanged += HandleContextStateChanged;
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            // Store trigger element reference in context
            Context.State.TriggerElement = _buttonElement;
        }
    }

    private void HandleClick()
    {
        Context.Toggle(_buttonElement);
    }

    private void HandleKeyDown(KeyboardEventArgs args)
    {
        if (Context.Disabled) return;

        switch (args.Key)
        {
            case "Enter":
            case " ": // Space
            case "ArrowDown":
            case "ArrowUp":
                Context.Open(_buttonElement);
                break;
            case "Escape":
                if (Context.IsOpen)
                {
                    Context.Close();
                }
                break;
        }
    }

    private void HandleContextStateChanged()
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        if (Context != null)
        {
            Context.OnStateChanged -= HandleContextStateChanged;
        }
    }
}

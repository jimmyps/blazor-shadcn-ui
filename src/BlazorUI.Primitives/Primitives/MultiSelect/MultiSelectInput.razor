@namespace BlazorUI.Primitives.MultiSelect
@inject IJSRuntime JS
@implements IAsyncDisposable

@* MultiSelectInput primitive - headless input element for search/filtering *@
<input @ref="_inputElement"
       id="@Context.InputId"
       type="text"
       role="combobox"
       autocomplete="off"
       aria-expanded="@(Context.IsOpen ? "true" : "false")"
       aria-controls="@Context.ContentId"
       aria-activedescendant="@_focusedItemId"
       aria-multiselectable="true"
       value="@Context.SearchQuery"
       @oninput="HandleInput"
       disabled="@Context.Disabled"
       @attributes="AdditionalAttributes" />

@code {
    [CascadingParameter]
    public MultiSelectContext Context { get; set; } = null!;

    private ElementReference _inputElement;
    private string? _focusedItemId;
    private IJSObjectReference? _jsModule;
    private DotNetObjectReference<MultiSelectInput>? _dotNetRef;
    private bool _previousAutoFocus;

    /// <summary>
    /// Additional attributes to apply to the input element.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    /// <summary>
    /// Gets or sets whether the input should auto-focus when rendered.
    /// </summary>
    [Parameter]
    public bool AutoFocus { get; set; }

    protected override void OnInitialized()
    {
        if (Context == null)
        {
            throw new InvalidOperationException($"{nameof(MultiSelectInput)} must be used within a {nameof(MultiSelect)} component.");
        }

        // Subscribe to context state changes to update ARIA attributes
        Context.OnStateChanged += HandleContextStateChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Store input element reference in context
            Context.State.InputElement = _inputElement;

            // Set up JavaScript interop for keyboard navigation
            try
            {
                _jsModule = await JS.InvokeAsync<IJSObjectReference>(
                    "import", "./_content/NeoBlazorUI.Primitives/js/primitives/multiselect.js");

                _dotNetRef = DotNetObjectReference.Create(this);

                await _jsModule.InvokeVoidAsync("setupMultiSelectInput",
                    _inputElement, _dotNetRef, Context.InputId, Context.ContentId);
            }
            catch (Exception ex)
            {
                // JS module not critical, log and continue
                Console.WriteLine($"Failed to setup multiselect keyboard handler: {ex.Message}");
            }
        }

        // Auto-focus when AutoFocus changes from false to true (dropdown opens)
        if (AutoFocus && !_previousAutoFocus && _jsModule != null)
        {
            try
            {
                await _jsModule.InvokeVoidAsync("focusElementByIdWithPreventScroll", Context.InputId);
            }
            catch
            {
                // Ignore focus errors
            }
        }

        // Update previous state for next render
        _previousAutoFocus = AutoFocus;
    }

    private void HandleInput(ChangeEventArgs e)
    {
        var newQuery = e.Value?.ToString() ?? string.Empty;
        Context.UpdateSearchQuery(newQuery);
        StateHasChanged();
    }

    /// <summary>
    /// Handles Escape key from JavaScript to close dropdown.
    /// </summary>
    [JSInvokable]
    public void HandleEscape()
    {
        Context.Close();
    }

    /// <summary>
    /// Handles Space key from JavaScript to toggle focused item.
    /// </summary>
    [JSInvokable]
    public async Task HandleSpace()
    {
        await Context.ToggleFocusedItem();
    }

    /// <summary>
    /// Handles Enter key from JavaScript to toggle focused item and close.
    /// </summary>
    [JSInvokable]
    public async Task HandleEnter()
    {
        await Context.ToggleFocusedItemAndClose();
    }

    private void HandleContextStateChanged()
    {
        // Update ARIA attributes based on context state
        var filteredItems = Context.GetFilteredItems();

        if (Context.FocusedIndex >= 0 && Context.FocusedIndex < filteredItems.Count)
        {
            _focusedItemId = Context.GetItemId(Context.FocusedIndex);
        }
        else
        {
            _focusedItemId = null;
        }

        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (Context != null)
        {
            Context.OnStateChanged -= HandleContextStateChanged;
        }

        // Cleanup JavaScript interop
        if (_jsModule != null && Context != null)
        {
            try
            {
                await _jsModule.InvokeVoidAsync("removeMultiSelectInput", Context.InputId);
                await _jsModule.DisposeAsync();
            }
            catch
            {
                // Ignore disposal errors
            }
        }

        _dotNetRef?.Dispose();
    }
}

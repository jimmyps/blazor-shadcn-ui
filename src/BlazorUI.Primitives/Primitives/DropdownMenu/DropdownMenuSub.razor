@namespace BlazorUI.Primitives.DropdownMenu

@* DropdownMenuSub - container for a submenu within a dropdown menu *@
<CascadingValue Value="@_context" IsFixed="false">
    @ChildContent
</CascadingValue>

@code {
    private readonly DropdownMenuSubContext _context = new();

    [CascadingParameter]
    private DropdownMenuContext? MenuContext { get; set; }

    [CascadingParameter(Name = "ParentSubContext")]
    private DropdownMenuSubContext? ParentSubContext { get; set; }

    /// <summary>
    /// The content to render inside the submenu.
    /// Typically contains DropdownMenuSubTrigger and DropdownMenuSubContent.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Controls whether the submenu is open (controlled mode).
    /// </summary>
    [Parameter]
    public bool? Open { get; set; }

    /// <summary>
    /// Event callback invoked when the open state changes.
    /// </summary>
    [Parameter]
    public EventCallback<bool> OpenChanged { get; set; }

    /// <summary>
    /// Event callback invoked when the submenu open state changes.
    /// </summary>
    [Parameter]
    public EventCallback<bool> OnOpenChange { get; set; }

    protected override void OnInitialized()
    {
        // Set depth based on parent submenu depth (for proper z-index stacking)
        // First-level submenu = depth 0, second-level = depth 1, etc.
        _context.Depth = ParentSubContext != null ? ParentSubContext.Depth + 1 : 0;

        if (Open.HasValue)
        {
            _context.IsOpen = Open.Value;
        }

        _context.OnOpenChange = HandleOpenChange;
    }

    protected override void OnParametersSet()
    {
        if (Open.HasValue && _context.IsOpen != Open.Value)
        {
            _context.IsOpen = Open.Value;
        }
    }

    private async Task HandleOpenChange(bool isOpen)
    {
        _context.IsOpen = isOpen;

        await OpenChanged.InvokeAsync(isOpen);
        if (OnOpenChange.HasDelegate)
        {
            await OnOpenChange.InvokeAsync(isOpen);
        }
    }
}

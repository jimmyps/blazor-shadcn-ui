@namespace BlazorUI.Primitives.DropdownMenu
@implements IDropdownMenuItem
@implements IDisposable

@* Dropdown menu item - represents an individual menu action *@
<div @ref="_itemRef"
     role="menuitem"
<<<<<<< HEAD
     tabindex="-1"
     aria-disabled="@Disabled.ToString().ToLowerInvariant()"
     data-disabled="@Disabled.ToString().ToLowerInvariant()"
     @onclick="HandleClick"
     @onkeydown="HandleKeyDown"
     @onmouseenter="HandleMouseEnter"
=======
     tabindex="@(Disabled ? -1 : -1)"
     aria-disabled="@Disabled.ToString().ToLower()"
     data-disabled="@(Disabled ? "true" : null)"
     @onclick="HandleClick"
     @onkeydown="HandleKeyDown"
     @onkeydown:preventDefault="true"
>>>>>>> pr-89
     @attributes="AdditionalAttributes">
    @ChildContent
</div>

@code {
    [CascadingParameter]
    private DropdownMenuContext Context { get; set; } = null!;

<<<<<<< HEAD
    [CascadingParameter]
    private DropdownMenuContent? ContentContext { get; set; }
    
    [CascadingParameter(Name = "ParentSubContext")]
    private DropdownMenuSubContext? ParentSubContext { get; set; }
    
    [CascadingParameter]
    private DropdownMenuSubContent? SubContentContext { get; set; }
=======
    [CascadingParameter(Name = "DropdownMenuContentContext")]
    private DropdownMenuContent? ContentContext { get; set; }
>>>>>>> pr-89

    private ElementReference _itemRef;

    /// <summary>
    /// The content to display inside the menu item.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Additional attributes to apply to the menu item element.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    /// <summary>
    /// Whether the menu item is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; } = false;

    /// <summary>
    /// Custom click handler. If provided, this is called when the item is clicked.
    /// The menu will close after the handler executes unless CloseOnSelect is false.
    /// </summary>
    [Parameter]
    public EventCallback<MouseEventArgs> OnClick { get; set; }

    /// <summary>
    /// Whether to close the dropdown menu when this item is selected.
    /// Default is true.
    /// </summary>
    [Parameter]
    public bool CloseOnSelect { get; set; } = true;

    protected override void OnInitialized()
    {
        if (Context == null)
        {
            throw new InvalidOperationException(
                "DropdownMenuItem must be used within a DropdownMenu component. " +
                "Ensure DropdownMenuItem is a child of a DropdownMenu component.");
        }

<<<<<<< HEAD
        // Register this item with the appropriate content for keyboard navigation
        // If we're inside a submenu, register with the submenu content
        // Otherwise, register with the root menu content
        if (SubContentContext != null)
        {
            SubContentContext.RegisterMenuItem(this);
        }
        else
        {
            ContentContext?.RegisterMenuItem(this);
        }
=======
        // Register this item with the content for keyboard navigation
        ContentContext?.RegisterMenuItem(this);
>>>>>>> pr-89
    }

    private async Task HandleClick(MouseEventArgs args)
    {
        if (Disabled) return;

        // Invoke custom click handler if provided
        if (OnClick.HasDelegate)
        {
            await OnClick.InvokeAsync(args);
        }

        // Close the dropdown menu if configured
        if (CloseOnSelect && Context != null)
        {
            Context.Close();
        }
    }

    private void HandleKeyDown(KeyboardEventArgs args)
    {
        if (Disabled) return;

        // Enter or Space to activate
        if (args.Key == "Enter" || args.Key == " ")
        {
            _ = ClickAsync();
        }
    }

<<<<<<< HEAD
    private async void HandleMouseEnter(MouseEventArgs args)
    {
        // Track if there was an active submenu that we're closing
        bool hadActiveSubmenu = false;
        
        // Close any active submenu when hovering over this item
        // If we're inside a submenu (ParentSubContext exists), close nested submenus of that parent
        // If we're at root level, close any active submenu from the root context
        if (ParentSubContext != null)
        {
            // We're inside a submenu - close any nested submenus
            hadActiveSubmenu = ParentSubContext.ActiveSubMenu != null;
            ParentSubContext.CloseActiveSubMenu();
        }
        else
        {
            // We're at root level - close active submenu from root context
            hadActiveSubmenu = Context?.ActiveSubMenu != null;
            Context?.CloseActiveSubMenu();
        }
        
        // Restore focus to the menu container (not the item) when we closed a submenu
        // This enables keyboard navigation without showing focus ring on a specific item
        if (hadActiveSubmenu)
        {
            // Focus the content container - if in submenu, focus SubContentContext, else ContentContext
            if (SubContentContext != null)
            {
                await SubContentContext.FocusContainerAsync();
            }
            else if (ContentContext != null)
            {
                await ContentContext.FocusContainerAsync();
            }
        }
    }

=======
>>>>>>> pr-89
    // IDropdownMenuItem implementation
    public async Task FocusAsync()
    {
        try
        {
            await _itemRef.FocusAsync();
        }
        catch
        {
            // Ignore focus errors (element might not be mounted yet)
        }
    }

    public async Task ClickAsync()
    {
        if (Disabled) return;
        await HandleClick(new MouseEventArgs());
    }

    public void Dispose()
    {
        // Unregister this item when disposed
<<<<<<< HEAD
        if (SubContentContext != null)
        {
            SubContentContext.UnregisterMenuItem(this);
        }
        else
        {
            ContentContext?.UnregisterMenuItem(this);
        }
=======
        ContentContext?.UnregisterMenuItem(this);
>>>>>>> pr-89
    }
}

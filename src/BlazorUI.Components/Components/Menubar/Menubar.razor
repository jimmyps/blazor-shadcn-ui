@namespace BlazorUI.Components.Menubar

<div role="menubar" class="@CssClass" @onkeydown="HandleKeyDown">
    <CascadingValue Value="this" IsFixed="false">
        @ChildContent
    </CascadingValue>
</div>

@code {
    [Parameter]
    public string? Class { get; set; }

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    internal string? ActiveMenu { get; private set; }

    private List<MenubarMenu> _menus = new();

    internal void RegisterMenu(MenubarMenu menu)
    {
        if (!_menus.Contains(menu))
        {
            _menus.Add(menu);
        }
    }

    internal void UnregisterMenu(MenubarMenu menu)
    {
        _menus.Remove(menu);
    }

    internal List<MenubarMenu> GetMenus() => _menus;

    internal void SetActiveMenu(string? menuId)
    {
        ActiveMenu = menuId;
        StateHasChanged();
    }

    internal void NavigateToNextMenu()
    {
        if (_menus.Count == 0 || ActiveMenu == null) return;

        var currentIndex = _menus.FindIndex(m => m.MenuId == ActiveMenu);
        if (currentIndex == -1) return;

        var nextIndex = (currentIndex + 1) % _menus.Count;
        _menus[nextIndex].Open();
    }

    internal void NavigateToPreviousMenu()
    {
        if (_menus.Count == 0 || ActiveMenu == null) return;

        var currentIndex = _menus.FindIndex(m => m.MenuId == ActiveMenu);
        if (currentIndex == -1) return;

        var prevIndex = currentIndex == 0 ? _menus.Count - 1 : currentIndex - 1;
        _menus[prevIndex].Open();
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (ActiveMenu == null) return;

        switch (e.Key)
        {
            case "ArrowRight":
                NavigateToNextMenu();
                break;
            case "ArrowLeft":
                NavigateToPreviousMenu();
                break;
        }
    }

    private string CssClass => BlazorUI.Components.Utilities.ClassNames.cn(
        "relative z-50 flex h-10 items-center space-x-1 rounded-md border bg-background p-1",
        Class
    );
}

@namespace BlazorUI.Components.Dialog
@using BlazorUI.Components.Utilities
@using BlazorUI.Primitives.Dialog
@using BlazorUI.Primitives.Constants
@using BlazorUI.Icons.Lucide.Components

@*
    Styled DialogContent component with shadcn/ui classes.
    Includes overlay, dialog box, and close button.
*@

<DialogPortal>
    <DialogOverlay class="@GetOverlayClass()" />

    <BlazorUI.Primitives.Dialog.DialogContent
        class="@GetClassNames()"
        CloseOnEscape="@CloseOnEscape"
        TrapFocus="@TrapFocus"
        LockScroll="@LockScroll"
        OnEscapeKeyDown="@OnEscapeKeyDown"
        @attributes="AdditionalAttributes">
        @ChildContent

        @if (ShowClose)
        {
            <BlazorUI.Primitives.Dialog.DialogClose class="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
                <LucideIcon Name="x" Class="h-4 w-4" />
                <span class="sr-only">Close</span>
            </BlazorUI.Primitives.Dialog.DialogClose>
        }
    </BlazorUI.Primitives.Dialog.DialogContent>
</DialogPortal>

@code {
    /// <summary>
    /// The content to render inside the dialog.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the dialog content.
    /// </summary>
    [Parameter]
    public string? Class { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the dialog overlay/backdrop.
    /// Merged with built-in defaults using ClassNames.cn.
    /// </summary>
    [Parameter]
    public string? OverlayClass { get; set; }

    /// <summary>
    /// When true, do not include default animation-related classes
    /// so consumers can provide completely custom animations.
    /// </summary>
    [Parameter]
    public bool UseCustomAnimations { get; set; } = false;

    /// <summary>
    /// Additional attributes to apply to the dialog content.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    /// <summary>
    /// Whether to show the close button (X icon).
    /// Default is true.
    /// </summary>
    [Parameter]
    public bool ShowClose { get; set; } = true;

    /// <summary>
    /// Whether pressing Escape should close the dialog.
    /// Default is true.
    /// </summary>
    [Parameter]
    public bool CloseOnEscape { get; set; } = true;

    /// <summary>
    /// Whether to trap focus within the dialog.
    /// Default is true for modal dialogs.
    /// </summary>
    [Parameter]
    public bool TrapFocus { get; set; } = true;

    /// <summary>
    /// Whether to lock body scroll when dialog is open.
    /// Default is true for modal dialogs.
    /// </summary>
    [Parameter]
    public bool LockScroll { get; set; } = true;

    /// <summary>
    /// Event callback invoked when Escape key is pressed.
    /// </summary>
    [Parameter]
    public EventCallback<KeyboardEventArgs> OnEscapeKeyDown { get; set; }

    /// <summary>
    /// Gets the computed CSS classes for the dialog content.
    /// Uses the cn() utility for intelligent class merging and Tailwind conflict resolution.
    /// </summary>
    private string GetClassNames()
    {
        var baseClasses = new List<string>
        {
            $"fixed left-[50%] top-[50%] z-{ZIndexLevels.DialogContent} grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%]",
            "gap-4 border bg-background p-6 shadow-lg backdrop-blur-sm",
            "sm:rounded-lg"
        };

        if (!UseCustomAnimations)
        {
            baseClasses.AddRange(new[]
            {
                "data-[state=open]:animate-in data-[state=closed]:animate-out",
                "data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
                "data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-75",
                "animate-duration-300 animate-ease-cubic-out"
            });
        }

        return ClassNames.cn(baseClasses.Append(Class).ToArray());
    }

    /// <summary>
    /// Gets the computed CSS classes for the dialog overlay/backdrop.
    /// Merges built-in defaults with user-defined OverlayClass.
    /// </summary>
    private string GetOverlayClass()
    {
        var baseClasses = new List<string>
        {
            $"fixed inset-0 z-{ZIndexLevels.DialogOverlay} bg-black/40"
        };

        if (!UseCustomAnimations)
        {
            baseClasses.AddRange(new[]
            {
                "data-[state=open]:animate-in data-[state=closed]:animate-out",
                "data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
                "animate-duration-200 animate-ease-out"
            });
        }

        baseClasses.Add(OverlayClass ?? string.Empty);
        return ClassNames.cn(baseClasses.ToArray());
    }
}

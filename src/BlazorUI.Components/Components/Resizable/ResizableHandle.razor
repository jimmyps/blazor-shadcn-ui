@namespace BlazorUI.Components.Resizable
<<<<<<< HEAD
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

@* ResizableHandle - draggable handle between panels *@
<div @ref="_handleRef"
     @attributes="GetAttributes()">
    @if (WithHandle)
    {
        <div class="z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border">
            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="@GetGripIconClass()">
                <circle cx="12" cy="5" r="1"></circle>
                <circle cx="12" cy="12" r="1"></circle>
                <circle cx="12" cy="19" r="1"></circle>
                <circle cx="19" cy="5" r="1"></circle>
                <circle cx="19" cy="12" r="1"></circle>
                <circle cx="19" cy="19" r="1"></circle>
                <circle cx="5" cy="5" r="1"></circle>
                <circle cx="5" cy="12" r="1"></circle>
                <circle cx="5" cy="19" r="1"></circle>
=======

<div class="@CssClass" @onmousedown="HandleMouseDown">
    @if (WithHandle)
    {
        <div class="@HandleIconClass">
            <svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M5.5 4.625C6.12132 4.625 6.625 4.12132 6.625 3.5C6.625 2.87868 6.12132 2.375 5.5 2.375C4.87868 2.375 4.375 2.87868 4.375 3.5C4.375 4.12132 4.87868 4.625 5.5 4.625ZM9.5 4.625C10.1213 4.625 10.625 4.12132 10.625 3.5C10.625 2.87868 10.1213 2.375 9.5 2.375C8.87868 2.375 8.375 2.87868 8.375 3.5C8.375 4.12132 8.87868 4.625 9.5 4.625ZM10.625 7.5C10.625 8.12132 10.1213 8.625 9.5 8.625C8.87868 8.625 8.375 8.12132 8.375 7.5C8.375 6.87868 8.87868 6.375 9.5 6.375C10.1213 6.375 10.625 6.87868 10.625 7.5ZM5.5 8.625C6.12132 8.625 6.625 8.12132 6.625 7.5C6.625 6.87868 6.12132 6.375 5.5 6.375C4.87868 6.375 4.375 6.87868 4.375 7.5C4.375 8.12132 4.87868 8.625 5.5 8.625ZM10.625 11.5C10.625 12.1213 10.1213 12.625 9.5 12.625C8.87868 12.625 8.375 12.1213 8.375 11.5C8.375 10.8787 8.87868 10.375 9.5 10.375C10.1213 10.375 10.625 10.8787 10.625 11.5ZM5.5 12.625C6.12132 12.625 6.625 12.1213 6.625 11.5C6.625 10.8787 6.12132 10.375 5.5 10.375C4.87868 10.375 4.375 10.8787 4.375 11.5C4.375 12.1213 4.87868 12.625 5.5 12.625Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path>
>>>>>>> 8835bfed9859e4bf8349954ac05f732fe9ffddcf
            </svg>
        </div>
    }
</div>

@code {
    [CascadingParameter]
    private ResizablePanelGroup? Group { get; set; }

<<<<<<< HEAD
    private ElementReference _handleRef;
    private IJSObjectReference? _resizableModule;
    private IJSObjectReference? _resizeCleanup;
    private DotNetObjectReference<ResizableHandle>? _dotNetRef;
    private bool _isInitialized = false;

    /// <summary>
    /// The index of the handle (zero-based, between panels).
    /// </summary>
    [Parameter]
    public int Index { get; set; }

    /// <summary>
    /// Whether to show a visual grip handle.
    /// Default is false.
    /// </summary>
    [Parameter]
    public bool WithHandle { get; set; } = false;

    /// <summary>
    /// Additional CSS classes to apply to the handle.
=======
    /// <summary>
    /// Whether to show the grip handle icon.
    /// </summary>
    [Parameter]
    public bool WithHandle { get; set; } = true;

    /// <summary>
    /// Additional CSS classes to apply.
>>>>>>> 8835bfed9859e4bf8349954ac05f732fe9ffddcf
    /// </summary>
    [Parameter]
    public string? Class { get; set; }

<<<<<<< HEAD
    /// <summary>
    /// Additional attributes to apply to the handle element.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isInitialized && Group != null)
        {
            await InitializeJsInteropAsync();
        }
    }

    private async Task InitializeJsInteropAsync()
    {
        try
        {
            _resizableModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
                "import", "./_content/NeoBlazorUI.Components/js/resizable.js");

            _dotNetRef = DotNetObjectReference.Create(this);

            var groupElement = Group?.GetGroupElement();
            if (groupElement.HasValue)
            {
                var direction = Group?.GetDirection() ?? ResizableDirection.Horizontal;
                _resizeCleanup = await _resizableModule.InvokeAsync<IJSObjectReference>(
                    "initResizeHandle", 
                    _handleRef, 
                    groupElement.Value, 
                    _dotNetRef, 
                    Index, 
                    direction.ToString().ToLowerInvariant());
                
                _isInitialized = true;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to initialize resizable handle: {ex.Message}");
        }
    }

    /// <summary>
    /// Called from JavaScript when the handle is dragged.
    /// </summary>
    [JSInvokable]
    public async Task HandleDrag(int handleIndex, double deltaPercent)
    {
        if (Group != null)
        {
            await Group.ResizePanels(handleIndex, deltaPercent);
        }
    }

    /// <summary>
    /// Called from JavaScript when drag ends.
    /// </summary>
    [JSInvokable]
    public Task HandleDragEnd(int handleIndex)
    {
        // Can be used for final adjustments or callbacks
        return Task.CompletedTask;
    }

    /// <summary>
    /// Called from JavaScript for collapse functionality (Home/End keys).
    /// </summary>
    [JSInvokable]
    public async Task HandleCollapse(int handleIndex, string target)
    {
        if (Group != null)
        {
            await Group.CollapsePanel(handleIndex, target);
        }
    }

    private string GetGripIconClass()
    {
        if (Group?.GetDirection() == ResizableDirection.Vertical)
        {
            return "rotate-90";
        }
        return "";
    }

    private Dictionary<string, object> GetAttributes()
    {
        var direction = Group?.GetDirection() ?? ResizableDirection.Horizontal;
        var baseClass = "relative flex w-px items-center justify-center bg-border " +
                       "after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 " +
                       "focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 " +
                       "data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full " +
                       "data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 " +
                       "data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 " +
                       "data-[panel-group-direction=vertical]:after:translate-x-0 " +
                       "[&[data-panel-group-direction=vertical]>div]:rotate-90";

        var classValue = string.IsNullOrEmpty(Class) ? baseClass : $"{baseClass} {Class}";

        var attributes = new Dictionary<string, object>
        {
            ["class"] = classValue,
            ["role"] = "separator",
            ["aria-valuenow"] = Group?.GetPanelSize(Index).ToString("F0") ?? "50",
            ["aria-valuemin"] = "0",
            ["aria-valuemax"] = "100",
            ["tabindex"] = "0",
            ["data-panel-resize-handle-enabled"] = "true",
            ["data-panel-resize-handle-id"] = Index.ToString(),
            ["data-panel-group-direction"] = direction.ToString().ToLowerInvariant(),
            ["style"] = "cursor: " + (direction == ResizableDirection.Horizontal ? "col-resize" : "row-resize") + ";"
        };

        if (AdditionalAttributes != null)
        {
            foreach (var kvp in AdditionalAttributes.Where(kvp => kvp.Key != "class" && kvp.Key != "style"))
            {
                attributes[kvp.Key] = kvp.Value;
            }
        }

        return attributes;
    }

    public async ValueTask DisposeAsync()
    {
        if (_resizeCleanup != null)
        {
            try
            {
                await _resizeCleanup.InvokeVoidAsync("dispose");
                await _resizeCleanup.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Expected during circuit disconnection
            }
            catch (ObjectDisposedException)
            {
                // Already disposed
            }
            _resizeCleanup = null;
        }

        if (_resizableModule != null)
        {
            try
            {
                await _resizableModule.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Expected during circuit disconnection
            }
            catch (ObjectDisposedException)
            {
                // Already disposed
            }
            _resizableModule = null;
        }

        _dotNetRef?.Dispose();
        _dotNetRef = null;
    }
=======
    private int _handleIndex = -1;

    private bool IsHorizontal => Group?.GetDirection() == ResizableDirection.Horizontal;

    protected override void OnInitialized()
    {
        if (Group != null)
        {
            _handleIndex = Group.RegisterHandle();
        }
    }

    private async Task HandleMouseDown(MouseEventArgs e)
    {
        if (Group != null && _handleIndex >= 0)
        {
            await Group.StartResize(_handleIndex, e.ClientX, e.ClientY);
        }
    }

    private string CssClass => BlazorUI.Components.Utilities.ClassNames.cn(
        "relative flex items-center justify-center bg-border",
        IsHorizontal
            ? "w-px cursor-col-resize hover:bg-primary/50 active:bg-primary"
            : "h-px cursor-row-resize hover:bg-primary/50 active:bg-primary",
        "after:absolute after:inset-y-0 after:left-1/2 after:-translate-x-1/2",
        IsHorizontal ? "after:w-1" : "after:h-1",
        Class
    );

    private string HandleIconClass => BlazorUI.Components.Utilities.ClassNames.cn(
        "z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border",
        IsHorizontal ? "rotate-90" : ""
    );
>>>>>>> 8835bfed9859e4bf8349954ac05f732fe9ffddcf
}

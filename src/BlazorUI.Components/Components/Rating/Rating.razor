@namespace BlazorUI.Components.Rating

<div class="@ContainerCssClass" 
     id="@Id" 
     tabindex="@(Disabled || ReadOnly ? -1 : 0)"
     @onkeydown="OnKeyDown"
     @onmouseleave="OnMouseLeave">
    @for (int i = 1; i <= MaxRating; i++)
    {
        var iconIndex = i; // Capture for closure
        var hoverZIndex = "z-10";
        
        @if (AllowHalf)
        {
            <div class="relative inline-flex">
                <!-- Half icon (left side) -->
                <div class="@($"absolute inset-0 w-1/2 overflow-hidden cursor-pointer {hoverZIndex}")"
                     @onclick="() => OnIconClick(iconIndex, true)"
                     @onmouseenter="() => OnIconMouseEnter(iconIndex, true)">
                </div>
                
                <!-- Full icon (right side) -->
                <div class="@($"absolute inset-0 left-1/2 w-1/2 overflow-hidden cursor-pointer {hoverZIndex}")"
                     @onclick="() => OnIconClick(iconIndex, false)"
                     @onmouseenter="() => OnIconMouseEnter(iconIndex, false)">
                </div>
                
                <!-- Icon display -->
                @if (IsIconFilled(iconIndex))
                {
                    @RenderIcon(true)
                }
                else if (IsIconHalfFilled(iconIndex))
                {
                    <div class="relative">
                        <div class="absolute inset-0 w-1/2 overflow-hidden">
                            @RenderIcon(true)
                        </div>
                        @RenderIcon(false)
                    </div>
                }
                else
                {
                    @RenderIcon(false)
                }
            </div>
        }
        else
        {
            <div @onclick="() => OnIconClick(iconIndex, false)"
                 @onmouseenter="() => OnIconMouseEnter(iconIndex, false)">
                @if (IsIconFilled(iconIndex))
                {
                    @RenderIcon(true)
                }
                else
                {
                    @RenderIcon(false)
                }
            </div>
        }
    }
    
    @if (!string.IsNullOrEmpty(Name))
    {
        <input type="hidden" name="@Name" value="@Value" />
    }
</div>

@if (ShowValidationError && EditContext != null && ValueExpression != null)
{
    <ValidationMessage For="@ValueExpression" />
}

@code {
    private RenderFragment RenderIcon(bool filled) => __builder =>
    {
        var fillColor = filled ? "fill-primary text-primary" : "fill-none text-muted-foreground";
        var cssClass = $"{IconSizeClass} {fillColor} transition-colors";
        
        switch (IconType)
        {
            case RatingIconType.Star:
                <svg class="@cssClass" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                break;
            case RatingIconType.Heart:
                <svg class="@cssClass" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                </svg>
                break;
            case RatingIconType.Circle:
                <svg class="@cssClass" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                </svg>
                break;
        }
    };
}

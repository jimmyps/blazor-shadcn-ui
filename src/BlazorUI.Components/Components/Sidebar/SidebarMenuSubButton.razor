@namespace BlazorUI.Components.Sidebar
@using BlazorUI.Components.Utilities
@using Microsoft.AspNetCore.Components.Routing
@inject NavigationManager NavigationManager

@*
    SidebarMenuSubButton component for clickable submenu items.
*@

@{
    // Auto-detect: if Href is provided and AsChild wasn't explicitly set to Button, render as Anchor
    var shouldRenderAsAnchor = AsChild == SidebarMenuButtonElement.Anchor ||
                               (Href != null && AsChild == SidebarMenuButtonElement.Button);
    var effectiveActive = GetEffectiveActiveState();
}

@if (shouldRenderAsAnchor)
{
    <NavLink href="@Href" class="@GetClasses()" data-active="@(effectiveActive ? "true" : "false")" aria-current="@(effectiveActive ? "page" : null)" Match="@Match" ActiveClass="data-[active=true]:bg-sidebar-accent" @attributes="AdditionalAttributes">
        @ChildContent
    </NavLink>
}
else
{
    <button type="button" class="@GetClasses()" data-active="@(effectiveActive ? " true" : "false" )" aria-current="@(effectiveActive ? "page" : null)" @attributes="AdditionalAttributes">
        @ChildContent
    </button>
}

@code {
    [CascadingParameter]
    private SidebarContext? Context { get; set; }

    /// <summary>
    /// The button content.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// The element tag to render. Defaults to Button, but automatically switches to Anchor if Href is provided.
    /// </summary>
    [Parameter]
    public SidebarMenuButtonElement AsChild { get; set; } = SidebarMenuButtonElement.Button;

    /// <summary>
    /// The URL to navigate to. When provided, the button automatically renders as a NavLink (unless AsChild is explicitly set to Button).
    /// </summary>
    [Parameter]
    public string? Href { get; set; }

    /// <summary>
    /// How the link should match the current URL. Default is NavLinkMatch.Prefix.
    /// </summary>
    [Parameter]
    public NavLinkMatch Match { get; set; } = NavLinkMatch.Prefix;

    /// <summary>
    /// Whether this submenu item is active/selected.
    /// If not set, active state will be auto-detected based on Href and Match if the Sidebar has AutoDetectActive enabled.
    /// </summary>
    [Parameter]
    public bool? IsActive { get; set; }

    /// <summary>
    /// Button size variant.
    /// </summary>
    [Parameter]
    public SidebarMenuSubButtonSize Size { get; set; } = SidebarMenuSubButtonSize.Medium;

    /// <summary>
    /// Additional CSS classes.
    /// </summary>
    [Parameter]
    public string? Class { get; set; }

    /// <summary>
    /// Additional attributes.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private bool GetEffectiveActiveState()
    {
        // If IsActive is explicitly set, use that value
        if (IsActive.HasValue)
        {
            return IsActive.Value;
        }

        // Otherwise, use auto-detected state if enabled
        if (Context?.AutoDetectActive == true && !string.IsNullOrEmpty(Href))
        {
            return IsPathActive(Href, Match);
        }

        return false;
    }

    private bool IsPathActive(string href, NavLinkMatch match)
    {
        if (Context == null || string.IsNullOrEmpty(href))
        {
            return false;
        }

        var currentPath = Context.CurrentPath;
        var hrefUri = NavigationManager.ToAbsoluteUri(href);
        var hrefPath = hrefUri.AbsolutePath;

        if (match == NavLinkMatch.All)
        {
            return string.Equals(currentPath, hrefPath, StringComparison.OrdinalIgnoreCase);
        }

        // NavLinkMatch.Prefix
        return currentPath.StartsWith(hrefPath, StringComparison.OrdinalIgnoreCase);
    }

    private string GetClasses()
    {
        var baseClasses = "flex w-full h-7 min-w-0 items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring transition-colors hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-muted-foreground hover:[&>svg]:text-sidebar-accent-foreground data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground";

        var sizeClasses = Size.ToValue() switch
        {
            "sm" => "text-xs",
            "md" => "text-sm",
            _ => ""
        };

        return ClassNames.cn(baseClasses, sizeClasses, Class);
    }
}

@namespace BlazorUI.Components.Sidebar
@using BlazorUI.Components.Utilities
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.JSInterop
@implements IAsyncDisposable

@*
    SidebarInset component that provides the main content area.
    Automatically adjusts margins based on sidebar state and variant.
    Supports automatic scroll reset on navigation.
*@

<main @ref="_mainElement" class="@GetClasses()" @attributes="AdditionalAttributes">
    @ChildContent
</main>

@code {
    private ElementReference _mainElement;
    private IJSObjectReference? _module;

    [CascadingParameter]
    private SidebarContext? Context { get; set; }

    [Inject]
    private IJSRuntime JSRuntime { get; set; } = null!;

    [Inject]
    private NavigationManager NavigationManager { get; set; } = null!;

    /// <summary>
    /// Whether to automatically reset scroll position to top on page navigation.
    /// Default is true.
    /// </summary>
    [Parameter]
    public bool ResetScrollOnNavigation { get; set; } = true;

    /// <summary>
    /// The main content to render.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the inset.
    /// </summary>
    [Parameter]
    public string? Class { get; set; }

    /// <summary>
    /// Additional attributes to apply to the main element.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    protected override void OnInitialized()
    {
        if (ResetScrollOnNavigation)
        {
            NavigationManager.LocationChanged += OnLocationChanged;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && ResetScrollOnNavigation)
        {
            try
            {
                _module = await JSRuntime.InvokeAsync<IJSObjectReference>(
                    "import", "./_content/NeoBlazorUI.Components/js/sidebar.js");
            }
            catch (JSException)
            {
                // Module loading error - silently handle
            }
            catch (InvalidOperationException)
            {
                // JS runtime not available - silently handle
            }
        }
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        // Reset scroll position to top on navigation
        if (_module != null)
        {
            try
            {
                await _module.InvokeVoidAsync("resetScrollPosition", _mainElement);
            }
            catch (JSException)
            {
                // JS execution error - silently handle
            }
            catch (InvalidOperationException)
            {
                // JS runtime not available - silently handle
            }
        }
    }

    private string GetClasses()
    {
        // Base classes with independent scrolling
        var baseClasses = "relative flex flex-1 flex-col bg-background focus:outline-none overflow-y-auto";
        
        // Height classes based on variant
        var heightClasses = Context?.Variant switch
        {
            SidebarVariant.Inset => "h-full",
            SidebarVariant.Floating => "h-screen",
            _ => "h-screen"
        };

        // Floating variant margins - push content when sidebar is visible
        // When sidebar is closed (hidden), remove margins
        var floatingClasses = Context?.Side == SidebarSide.Right
            ? "md:peer-data-[variant=floating]:mr-2 md:peer-data-[variant=floating]:peer-data-[state=collapsed]:mr-[calc(var(--sidebar-width-icon)+0.5rem+0.5rem)] md:peer-data-[variant=floating]:peer-data-[state=expanded]:mr-[calc(var(--sidebar-width)+0.5rem+0.5rem)] md:peer-data-[variant=floating]:peer-data-[state=closed]:mr-0"
            : "md:peer-data-[variant=floating]:ml-2 md:peer-data-[variant=floating]:peer-data-[state=collapsed]:ml-[calc(var(--sidebar-width-icon)+0.5rem+0.5rem)] md:peer-data-[variant=floating]:peer-data-[state=expanded]:ml-[calc(var(--sidebar-width)+0.5rem+0.5rem)] md:peer-data-[variant=floating]:peer-data-[state=closed]:ml-0";

        // Add margin transitions
        var transitionClasses = "transition-[margin] duration-200 ease-linear";

        // Inset variant specific styling - margin on all sides, rounded corners, shadow, and calculated height for margins
        var insetRoundingClasses = "md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:h-[calc(100%-1rem)] md:peer-data-[variant=inset]:min-h-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow md:peer-data-[variant=inset]:bg-background";

        return ClassNames.cn(
            baseClasses,
            heightClasses,
            floatingClasses,
            transitionClasses,
            insetRoundingClasses,
            Class
        );
    }

    public async ValueTask DisposeAsync()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;

        if (_module != null)
        {
            try
            {
                await _module.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // JS runtime already disconnected - silently handle
            }
        }
    }
}

@namespace BlazorUI.Components.Chart
@typeparam TData
@inherits BarChartBase<TData>
@implements IAsyncDisposable

<div class="@ContainerClass" style="position: relative; height: @(Height)px; width: 100%;">
    <canvas @ref="_canvasRef"></canvas>
</div>

@code {
    private ElementReference _canvasRef;
    private IChartRenderer? _renderer;
    private string? _chartId;
    private bool _isInitialized;
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && Data != null && Data.Any())
        {
            await InitializeChartAsync();
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        if (_isInitialized && Data != null && Data.Any())
        {
            await UpdateChartDataAsync();
        }
    }
    
    private async Task InitializeChartAsync()
    {
        try
        {
            _renderer = ChartRendererFactory.CreateRenderer(Engine, JSRuntime);
            
            var chartConfig = new ChartConfig
            {
                Type = ChartType.Bar,
                Responsive = Responsive,
                MaintainAspectRatio = false,
                Data = BuildChartData(),
                Options = BuildChartOptions()
            };
            
            _chartId = await _renderer.InitializeAsync(_canvasRef, chartConfig);
            _isInitialized = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to initialize chart: {ex.Message}");
        }
    }
    
    private async Task UpdateChartDataAsync()
    {
        if (_renderer != null && !string.IsNullOrEmpty(_chartId))
        {
            try
            {
                var chartData = BuildChartData();
                await _renderer.UpdateDataAsync(_chartId, chartData);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to update chart data: {ex.Message}");
            }
        }
    }
    
    private object BuildChartOptions()
    {
        var indexAxis = Orientation == BarChartOrientation.Horizontal ? "y" : "x";
        
        return new
        {
            indexAxis = indexAxis,
            responsive = Responsive,
            maintainAspectRatio = false,
            plugins = new
            {
                legend = new
                {
                    display = ShowLegend
                },
                tooltip = new
                {
                    enabled = ShowTooltip
                }
            },
            scales = new
            {
                x = new
                {
                    display = ShowXAxis,
                    stacked = Mode == BarChartMode.Stacked,
                    grid = new
                    {
                        display = ShowGrid
                    }
                },
                y = new
                {
                    display = ShowYAxis,
                    stacked = Mode == BarChartMode.Stacked,
                    grid = new
                    {
                        display = ShowGrid
                    }
                }
            },
            animation = new
            {
                duration = DisableAnimations ? 0 : (Animation?.Duration ?? 750),
                easing = ChartUtilities.MapEasingFunction(Animation?.Easing ?? AnimationEasing.EaseInOutQuart)
            }
        };
    }
    
    private object BuildChartData()
    {
        if (Data == null || !Data.Any())
        {
            return new
            {
                labels = Array.Empty<string>(),
                datasets = Array.Empty<object>()
            };
        }
        
        var labels = ExtractLabels();
        var datasets = BuildDatasets();
        
        return new
        {
            labels,
            datasets
        };
    }
    
    private string[] ExtractLabels()
    {
        if (Data == null || !Data.Any()) return Array.Empty<string>();
        
        if (!string.IsNullOrEmpty(XAxisDataKey))
        {
            return Data.Select(item =>
            {
                var prop = item?.GetType().GetProperty(XAxisDataKey);
                return prop?.GetValue(item)?.ToString() ?? "";
            }).ToArray();
        }
        
        return Data.Select((_, i) => i.ToString()).ToArray();
    }
    
    private object[] BuildDatasets()
    {
        if (string.IsNullOrEmpty(YAxisDataKey))
        {
            return Array.Empty<object>();
        }
        
        var values = Data.Select(item =>
        {
            var prop = item?.GetType().GetProperty(YAxisDataKey);
            var value = prop?.GetValue(item);
            
            if (value == null) return 0.0;
            
            return Convert.ToDouble(value);
        }).ToArray();
        
        return new[]
        {
            new
            {
                label = Label ?? YAxisDataKey,
                data = values,
                backgroundColor = BarColor ?? "hsl(var(--chart-1))",
                borderColor = BarColor ?? "hsl(var(--chart-1))",
                borderWidth = 1,
                borderRadius = BorderRadius,
                barThickness = BarThickness > 0 ? (int?)BarThickness : null
            }
        };
    }
    
    
    public async ValueTask DisposeAsync()
    {
        if (_renderer != null && !string.IsNullOrEmpty(_chartId))
        {
            try
            {
                await _renderer.DestroyAsync(_chartId);
            }
            catch
            {
                // Ignore disposal errors
            }
        }
        
        if (_renderer != null)
        {
            try
            {
                await _renderer.DisposeAsync();
            }
            catch
            {
                // Ignore disposal errors
            }
        }
    }
}

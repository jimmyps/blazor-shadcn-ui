@namespace BlazorUI.Components.Chart
@using BlazorUI.Components.Chart.Internal
@typeparam TData
@inherits ChartBase<TData>

<CascadingValue Value="this" IsFixed="true">
    <div class="chart-radialbar-container" style="width: 100%; height: 100%; position: relative;">
        <div @ref="_canvasRef" style="width: 100%; height: 100%;"></div>
    </div>
    @ChildContent
</CascadingValue>

@code {
    private List<RadialBar> _radialBars = new();
    private PolarGrid? _polarGrid;
    private CenterLabel? _centerLabel;
    
    /// <summary>
    /// Gets or sets the start angle in degrees (0-360).
    /// 90 = top, 0 = right, 180 = bottom, 270 = left.
    /// </summary>
    [Parameter]
    public int StartAngle { get; set; } = 90;
    
    /// <summary>
    /// Gets or sets the end angle in degrees.
    /// For full circle: 450 (90 + 360).
    /// For semi-circle gauge: 270 (90 + 180).
    /// </summary>
    [Parameter]
    public int EndAngle { get; set; } = 450;
    
    /// <summary>
    /// Gets or sets whether angle axis runs clockwise.
    /// </summary>
    [Parameter]
    public bool Clockwise { get; set; } = true;
    
    /// <summary>
    /// Gets or sets the minimum value for the radius axis.
    /// </summary>
    [Parameter]
    public double? RadiusMin { get; set; } = 0;
    
    /// <summary>
    /// Gets or sets the maximum value for the radius axis.
    /// </summary>
    [Parameter]
    public double? RadiusMax { get; set; }
    
    protected override EChartsOption BuildEChartsOption()
    {
        var option = new EChartsOption
        {
            Tooltip = BuildTooltip(),
            Legend = BuildLegend(),
            PolarCoordinateSystem = BuildPolarCoordinateSystem(),
            AngleAxis = BuildAngleAxis(),
            RadiusAxis = BuildRadiusAxis(),
            Series = BuildSeries(),
            Animation = EnableAnimation,
            AnimationDuration = EnableAnimation ? AnimationDuration : 0,
            AnimationEasing = MapAnimationEasing(AnimationEasing),
            AnimationDelay = AnimationDelay,
            AnimationDurationUpdate = AnimationDurationUpdate,
            AnimationEasingUpdate = MapAnimationEasing(AnimationEasingUpdate)
        };
        
        return option;
    }
    
    private EChartsPolar BuildPolarCoordinateSystem()
    {
        return new EChartsPolar
        {
            Center = new[] { "50%", "50%" },
            Radius = "75%"
        };
    }
    
    private EChartsAxis BuildAngleAxis()
    {
        var axis = new EChartsAxis
        {
            Type = "category",
            StartAngle = StartAngle,
            EndAngle = EndAngle,
            Clockwise = Clockwise
        };
        
        // Extract category data from XAxis if available
        if (_xAxis != null && !string.IsNullOrEmpty(_xAxis.DataKey))
        {
            axis.Data = DataExtractor.GetStringValues(Data, _xAxis.DataKey);
        }
        
        return axis;
    }
    
    private EChartsAxis BuildRadiusAxis()
    {
        var polarGrid = _polarGrid ?? new PolarGrid();
        
        var axis = new EChartsAxis
        {
            Type = "value",
            Min = RadiusMin,
            Max = RadiusMax,
            SplitNumber = polarGrid.SplitNumber
        };
        
        // Apply min/max from YAxis if available (takes precedence)
        if (_yAxis != null)
        {
            axis.Min = _yAxis.Min ?? RadiusMin;
            axis.Max = _yAxis.Max ?? RadiusMax;
        }
        
        // Apply axis line and split line settings
        axis.AxisLine = new EChartsAxisLine
        {
            Show = polarGrid.ShowAxisLine,
            LineStyle = new EChartsLineStyle
            {
                Color = polarGrid.Stroke,
                Width = polarGrid.StrokeWidth
            }
        };
        
        axis.SplitLine = new EChartsSplitLine
        {
            Show = polarGrid.ShowSplitLine,
            LineStyle = new EChartsLineStyle
            {
                Color = polarGrid.Stroke,
                Width = polarGrid.StrokeWidth
            }
        };
        
        return axis;
    }
    
    private List<EChartsSeries> BuildSeries()
    {
        var seriesList = new List<EChartsSeries>();
        
        if (_radialBars.Any())
        {
            for (int i = 0; i < _radialBars.Count; i++)
            {
                var radialBar = _radialBars[i];
                var data = DataExtractor.GetNumericValues(Data, radialBar.DataKey);
                
                var series = new EChartsSeries
                {
                    Type = "bar",
                    Name = radialBar.Name ?? radialBar.DataKey,
                    Data = data.Cast<object>().ToList(),
                    CoordinateSystem = "polar",
                    Stack = radialBar.StackId,
                    ItemStyle = new EChartsItemStyle
                    {
                        Color = GetSeriesColor(i, radialBar.Color),
                        BorderRadius = radialBar.CornerRadius
                    },
                    ShowBackground = radialBar.ShowBackground,
                    BackgroundStyle = radialBar.ShowBackground ? new EChartsBackgroundStyle
                    {
                        Color = radialBar.BackgroundColor ?? "rgba(180, 180, 180, 0.1)",
                        Opacity = radialBar.BackgroundOpacity
                    } : null
                };
                
                // Map label parameters
                if (radialBar.ShowLabel || radialBar.LabelList != null)
                {
                    var labelList = radialBar.LabelList;
                    series.Label = new EChartsLabel
                    {
                        Show = labelList?.Show ?? radialBar.ShowLabel,
                        Position = MapLabelPosition(labelList?.Position ?? radialBar.LabelPosition ?? LabelPosition.Center),
                        Formatter = labelList?.Formatter ?? radialBar.LabelFormatter,
                        Color = labelList?.Color,
                        FontSize = labelList?.FontSize,
                        Offset = labelList?.Offset
                    };
                }
                
                // Map animation properties (series-level overrides chart-level defaults)
                series.Animation = radialBar.EnableAnimation ?? EnableAnimation;
                series.AnimationDuration = radialBar.AnimationDuration ?? AnimationDuration;
                series.AnimationEasing = MapAnimationEasing(radialBar.AnimationEasing ?? AnimationEasing);
                series.AnimationDelay = radialBar.AnimationDelay ?? AnimationDelay;
                series.AnimationDurationUpdate = radialBar.AnimationDurationUpdate ?? AnimationDurationUpdate;
                series.AnimationEasingUpdate = MapAnimationEasing(radialBar.AnimationEasingUpdate ?? AnimationEasingUpdate);
                
                seriesList.Add(series);
            }
        }
        
        return seriesList;
    }
    
    private string MapLabelPosition(LabelPosition position)
    {
        return position switch
        {
            LabelPosition.Top => "top",
            LabelPosition.Bottom => "bottom",
            LabelPosition.Left => "left",
            LabelPosition.Right => "right",
            LabelPosition.Inside => "inside",
            LabelPosition.InsideTop => "insideTop",
            LabelPosition.InsideBottom => "insideBottom",
            LabelPosition.InsideLeft => "insideLeft",
            LabelPosition.InsideRight => "insideRight",
            LabelPosition.Center => "center",
            LabelPosition.Outside => "outside",
            _ => "center"
        };
    }
    
    protected override ChartType GetChartType()
    {
        return ChartType.Bar; // RadialBar uses Bar type with polar coordinate
    }
    
    protected override TooltipMode GetDefaultTooltipMode()
    {
        return TooltipMode.Item;
    }
    
    internal void RegisterRadialBar(RadialBar radialBar)
    {
        _radialBars.Add(radialBar);
        StateHasChanged();
    }
    
    internal void RegisterPolarGrid(PolarGrid polarGrid)
    {
        _polarGrid = polarGrid;
        StateHasChanged();
    }
    
    internal void RegisterCenterLabel(CenterLabel centerLabel)
    {
        _centerLabel = centerLabel;
        StateHasChanged();
    }
    
    internal void RegisterTooltip(Tooltip tooltip) { _tooltip = tooltip; StateHasChanged(); }
    internal void RegisterLegend(Legend legend) { _legend = legend; StateHasChanged(); }
    internal void RegisterXAxis(XAxis xAxis) { _xAxis = xAxis; StateHasChanged(); }
}

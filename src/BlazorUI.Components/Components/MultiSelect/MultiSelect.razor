@namespace BlazorUI.Components.MultiSelect
@typeparam TItem
@using BlazorUI.Components.Popover
@using BlazorUI.Components.Badge
@using BlazorUI.Components.Separator
@using BlazorUI.Components.InputGroup
@using BlazorUI.Components.Input
@using BlazorUI.Primitives.Services
@using BlazorUI.Primitives.Checkbox
@using BlazorUI.Icons.Lucide.Components

<div class="@ContainerClass">
    <Popover @bind-Open="_isOpen">
        <PopoverTrigger role="combobox"
                        aria-expanded="@_isOpen.ToString().ToLower()"
                        aria-controls="@($"{Id}-listbox")"
                        aria-haspopup="listbox"
                        aria-multiselectable="true"
                        disabled="@Disabled"
                        class="@TriggerCssClass">
            <div class="flex flex-wrap items-center gap-1 flex-1 min-w-0">
                @if (HasSelectedItems)
                {
                    @foreach (var value in SelectedValues.Take(MaxDisplayTags))
                    {
                        <Badge Variant="BadgeVariant.Secondary" Class="gap-1">
                            @GetDisplayText(value)
                            <button type="button"
                                    class="@TagRemoveButtonCssClass"
                                    aria-label="@($"Remove {GetDisplayText(value)}")"
                                    @onclick="@(() => RemoveValue(value))"
                                    @onclick:stopPropagation="true">
                                <LucideIcon Name="x" Size="12" Class="h-3 w-3" />
                            </button>
                        </Badge>
                    }
                    @if (OverflowCount > 0)
                    {
                        <span class="text-xs text-muted-foreground">+@OverflowCount more</span>
                    }
                }
                else
                {
                    <span class="text-muted-foreground">@Placeholder</span>
                }
            </div>
            <div class="flex items-center gap-1 ml-2">
                @if (HasSelectedItems)
                {
                    <button type="button"
                            class="rounded-sm opacity-70 hover:opacity-100 focus:outline-none focus:ring-1 focus:ring-ring"
                            aria-label="Clear all"
                            @onclick="ClearAll"
                            @onclick:stopPropagation="true">
                        <LucideIcon Name="x" Size="14" Class="h-3.5 w-3.5" />
                    </button>
                }
                <LucideIcon Name="chevron-down" Size="16" Class="h-4 w-4 shrink-0 opacity-50" />
            </div>
        </PopoverTrigger>

        <PopoverContent Side="@PopoverSide.Bottom"
                        Align="@PopoverAlign.Start"
                        CloseOnClickOutside="false"
                        CloseOnEscape="false"
                        Class="@($"{PopoverWidth} !p-0")">
            @* Search input section *@
            <InputGroup Class="!border-0 !border-b !border-border !rounded-none !shadow-none !ring-0 !ring-offset-0">
                <InputGroupAddon>
                    <LucideIcon Name="search" Size="16" Class="h-4 w-4 shrink-0 opacity-50" />
                </InputGroupAddon>
                <InputGroupInput Id="@($"{Id}-search")"
                                 Type="InputType.Search"
                                 Placeholder="@SearchPlaceholder"
                                 Value="@_searchQuery"
                                 ValueChanged="HandleSearchInputChanged"
                                 OnInputRef="HandleInputRefAsync"
                                 Class="h-11 py-3" />
            </InputGroup>

            @* Items list section *@
            <div id="@($"{Id}-listbox")" role="listbox" aria-multiselectable="true" class="max-h-[300px] overflow-y-auto p-1">
                @if (!HasFilteredItems)
                {
                    <div class="py-6 text-center text-sm text-muted-foreground">@EmptyMessage</div>
                }
                else
                {
                    @* Select All option *@
                    @if (ShowSelectAll)
                    {
                        var selectAllState = GetSelectAllState();
                        <div role="option"
                             aria-selected="@(selectAllState == SelectAllState.All ? "true" : "false")"
                             @onclick="HandleSelectAllToggle"
                             @onclick:stopPropagation="true"
                             class="@ItemCssClass">
                            <Checkbox Checked="@(selectAllState == SelectAllState.All)"
                                      Indeterminate="@(selectAllState == SelectAllState.Indeterminate)"
                                      class="@CheckboxCssClass"
                                      AriaLabel="@SelectAllLabel">
                                @if (selectAllState == SelectAllState.All)
                                {
                                    <LucideIcon Name="check" Size="14" Class="h-3.5 w-3.5 stroke-current" />
                                }
                                else if (selectAllState == SelectAllState.Indeterminate)
                                {
                                    <LucideIcon Name="minus" Size="14" Class="h-3.5 w-3.5 stroke-current" />
                                }
                            </Checkbox>
                            <span class="font-medium">@SelectAllLabel</span>
                        </div>
                        <Separator Decorative="false" Class="my-1" />
                    }

                    @* Individual items *@
                    @foreach (var item in FilteredItems)
                    {
                        var itemValue = ValueSelector(item);
                        var displayText = DisplaySelector(item);
                        var isSelected = IsSelected(item);

                        <div role="option"
                             aria-selected="@isSelected.ToString().ToLower()"
                             @onclick="@(() => HandleToggle(item))"
                             @onclick:stopPropagation="true"
                             class="@ItemCssClass">
                            <Checkbox Checked="@isSelected"
                                      class="@CheckboxCssClass"
                                      AriaLabel="@displayText">
                                @if (isSelected)
                                {
                                    <LucideIcon Name="check" Size="14" Class="h-3.5 w-3.5 stroke-current" />
                                }
                            </Checkbox>
                            <span>@displayText</span>
                        </div>
                    }
                }
            </div>

            @* Footer section *@
            <div class="flex items-center justify-between border-t p-2">
                <button type="button"
                        class="text-xs text-muted-foreground hover:text-foreground transition-colors"
                        @onclick="ClearAll"
                        @onclick:stopPropagation="true">
                    @ClearLabel
                </button>
                <button type="button"
                        class="text-xs text-muted-foreground hover:text-foreground transition-colors"
                        @onclick="Close"
                        @onclick:stopPropagation="true">
                    @CloseLabel
                </button>
            </div>
        </PopoverContent>
    </Popover>
</div>

@namespace BlazorUI.Components.RichTextEditor
@using Microsoft.JSInterop
@using BlazorUI.Icons.Lucide.Components
@using BlazorUI.Components.Toggle
@using BlazorUI.Components.Button
@using BlazorUI.Components.Separator
@using BlazorUI.Components.NativeSelect
@using BlazorUI.Components.Dialog
@using BlazorUI.Components.Input
@using BlazorUI.Components.Label
@inject IJSRuntime JS
@implements IAsyncDisposable

<div class="@ContainerCssClass" data-slot="rich-text-editor" id="@Id">
    @if (Toolbar != ToolbarPreset.None && ToolbarContent == null)
    {
        <div class="@ToolbarCssClass" data-slot="toolbar">
            <div class="flex items-center gap-0.5">
                @if (Toolbar >= ToolbarPreset.Standard)
                {
                    <NativeSelect TValue="string"
                                 Value="@_headerLevel"
                                 ValueChanged="@HandleHeaderChangeAsync"
                                 Disabled="@Disabled"
                                 Size="NativeSelectSize.Small"
                                 Class="w-auto min-w-[100px]">
                        <option value="">Normal</option>
                        <option value="1">Heading 1</option>
                        <option value="2">Heading 2</option>
                        <option value="3">Heading 3</option>
                    </NativeSelect>
                    <Separator Orientation="SeparatorOrientation.Vertical" Class="h-6 mx-1" />
                }

                <Toggle Pressed="@_isBold"
                        PressedChanged="@(async _ => await ToggleFormatAsync("bold"))"
                        Size="ToggleSize.Small"
                        Disabled="@Disabled"
                        Class="h-8 w-8 p-0"
                        title="Bold (Ctrl+B)">
                    <LucideIcon Name="bold" Size="16" />
                </Toggle>
                <Toggle Pressed="@_isItalic"
                        PressedChanged="@(async _ => await ToggleFormatAsync("italic"))"
                        Size="ToggleSize.Small"
                        Disabled="@Disabled"
                        Class="h-8 w-8 p-0"
                        title="Italic (Ctrl+I)">
                    <LucideIcon Name="italic" Size="16" />
                </Toggle>
                <Toggle Pressed="@_isUnderline"
                        PressedChanged="@(async _ => await ToggleFormatAsync("underline"))"
                        Size="ToggleSize.Small"
                        Disabled="@Disabled"
                        Class="h-8 w-8 p-0"
                        title="Underline (Ctrl+U)">
                    <LucideIcon Name="underline" Size="16" />
                </Toggle>

                @if (Toolbar >= ToolbarPreset.Standard)
                {
                    <Toggle Pressed="@_isStrike"
                            PressedChanged="@(async _ => await ToggleFormatAsync("strike"))"
                            Size="ToggleSize.Small"
                            Disabled="@Disabled"
                            Class="h-8 w-8 p-0"
                            title="Strikethrough">
                        <LucideIcon Name="strikethrough" Size="16" />
                    </Toggle>
                }

                <Separator Orientation="SeparatorOrientation.Vertical" Class="h-6 mx-1" />

                <Toggle Pressed="@_isBulletList"
                        PressedChanged="@(async _ => await ToggleFormatAsync("list", "bullet"))"
                        Size="ToggleSize.Small"
                        Disabled="@Disabled"
                        Class="h-8 w-8 p-0"
                        title="Bullet List">
                    <LucideIcon Name="list" Size="16" />
                </Toggle>
                <Toggle Pressed="@_isOrderedList"
                        PressedChanged="@(async _ => await ToggleFormatAsync("list", "ordered"))"
                        Size="ToggleSize.Small"
                        Disabled="@Disabled"
                        Class="h-8 w-8 p-0"
                        title="Numbered List">
                    <LucideIcon Name="list-ordered" Size="16" />
                </Toggle>

                @if (Toolbar >= ToolbarPreset.Standard)
                {
                    <Separator Orientation="SeparatorOrientation.Vertical" Class="h-6 mx-1" />
                    <Button Variant="ButtonVariant.Ghost"
                            Size="ButtonSize.IconSmall"
                            OnClick="@(async _ => await InsertLinkAsync())"
                            Disabled="@Disabled"
                            Class="h-8 w-8"
                            AriaLabel="Insert Link"
                            title="Insert Link">
                        <LucideIcon Name="link" Size="16" />
                    </Button>
                }

                @if (Toolbar == ToolbarPreset.Full)
                {
                    <Separator Orientation="SeparatorOrientation.Vertical" Class="h-6 mx-1" />
                    <Toggle Pressed="@_isBlockquote"
                            PressedChanged="@(async _ => await ToggleFormatAsync("blockquote"))"
                            Size="ToggleSize.Small"
                            Disabled="@Disabled"
                            Class="h-8 w-8 p-0"
                            title="Blockquote">
                        <LucideIcon Name="quote" Size="16" />
                    </Toggle>
                    <Toggle Pressed="@_isCodeBlock"
                            PressedChanged="@(async _ => await ToggleFormatAsync("code-block"))"
                            Size="ToggleSize.Small"
                            Disabled="@Disabled"
                            Class="h-8 w-8 p-0"
                            title="Code Block">
                        <LucideIcon Name="code" Size="16" />
                    </Toggle>
                }
            </div>
        </div>
    }

    @if (ToolbarContent != null)
    {
        <div class="@ToolbarCssClass" data-slot="custom-toolbar">
            @ToolbarContent
        </div>
    }

    <div @ref="_editorRef"
         class="@EditorCssClass"
         style="@EditorStyle"
         aria-label="@AriaLabel"
         aria-describedby="@AriaDescribedBy"
         aria-invalid="@(AriaInvalid?.ToString()?.ToLower())"
         data-slot="editor">
    </div>

    @* Link Dialog *@
    <Dialog @bind-Open="_linkDialogOpen">
        <DialogContent Class="sm:max-w-md">
            <DialogHeader>
                <DialogTitle>@(_hasExistingLink ? "Edit Link" : "Insert Link")</DialogTitle>
                <DialogDescription>
                    @(_hasExistingLink ? "Update the URL or remove the link." : "Enter the URL for the selected text.")
                </DialogDescription>
            </DialogHeader>
            <div class="grid gap-4 py-4">
                <div class="grid gap-2">
                    <Label For="link-url">URL</Label>
                    <Input Id="link-url"
                           Type="InputType.Url"
                           Placeholder="https://example.com"
                           @bind-Value="_linkUrl"
                           @bind-Value:after="ValidateLinkUrl" />
                    @if (!string.IsNullOrEmpty(_linkUrlError))
                    {
                        <p class="text-sm text-destructive">@_linkUrlError</p>
                    }
                </div>
            </div>
            <DialogFooter Class="flex-col sm:flex-row gap-2">
                @if (_hasExistingLink)
                {
                    <Button Variant="ButtonVariant.Destructive"
                            OnClick="RemoveLinkAsync"
                            Class="sm:mr-auto">
                        Remove Link
                    </Button>
                }
                <Button Variant="ButtonVariant.Outline" OnClick="CloseLinkDialog">
                    Cancel
                </Button>
                <Button OnClick="ApplyLinkAsync" Disabled="@(!IsValidUrl(_linkUrl))">
                    @(_hasExistingLink ? "Update" : "Insert")
                </Button>
            </DialogFooter>
        </DialogContent>
    </Dialog>
</div>

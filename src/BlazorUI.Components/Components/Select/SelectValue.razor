@typeparam TValue
@namespace BlazorUI.Components.Select
@using BlazorUI.Primitives.Select
@implements IDisposable

@if (!string.IsNullOrWhiteSpace(SelectContext?.DisplayText))
{
    @SelectContext.DisplayText
}
else
{
    <span class="text-muted-foreground">@Placeholder</span>
}

@code {
    [CascadingParameter]
    private SelectContext<TValue>? SelectContext { get; set; }

    /// <summary>
    /// Gets or sets the placeholder text to display when no value is selected.
    /// </summary>
    [Parameter]
    public string? Placeholder { get; set; }

    private bool _isSubscribed = false;

    protected override void OnParametersSet()
    {
        // Subscribe to context state changes for re-rendering
        // Context DisplayText is the source of truth - no caching needed
        if (SelectContext != null && !_isSubscribed)
        {
            SelectContext.OnStateChanged += HandleStateChanged;
            _isSubscribed = true;
        }
    }

    private void HandleStateChanged()
    {
        // Context DisplayText changed, trigger re-render
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        if (SelectContext != null && _isSubscribed)
        {
            SelectContext.OnStateChanged -= HandleStateChanged;
            _isSubscribed = false;
        }
    }
}

@namespace BlazorUI.Components.ScrollArea
@implements IAsyncDisposable
@inject IJSRuntime JSRuntime

@* ScrollArea - styled scrollable region with custom scrollbars and scroll shadows *@
<div @ref="_scrollAreaRef" @attributes="GetRootAttributes()">
    <div @ref="_viewportRef" 
         class="h-full w-full rounded-[inherit] [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]" 
         style="@GetOverflowStyle()"
         data-scroll-viewport>
        <div style="min-width: 100%; display: table;">
            @ChildContent
        </div>
    </div>
    
    @* Scroll shadows *@
    @if (EnableScrollShadows)
    {
        <div class="scroll-shadow scroll-shadow-top" data-scroll-shadow="top"></div>
        <div class="scroll-shadow scroll-shadow-bottom" data-scroll-shadow="bottom"></div>
        <div class="scroll-shadow scroll-shadow-left" data-scroll-shadow="left"></div>
        <div class="scroll-shadow scroll-shadow-right" data-scroll-shadow="right"></div>
    }
    
    @if (ShowVerticalScrollbar)
    {
        <ScrollBar Orientation="Orientation.Vertical" />
    }
    @if (ShowHorizontalScrollbar)
    {
        <ScrollBar Orientation="Orientation.Horizontal" />
    }
    @if (ShowVerticalScrollbar && ShowHorizontalScrollbar)
    {
        <div class="absolute right-0 bottom-0 h-2.5 w-2.5 bg-transparent"></div>
    }
</div>

@code {
    private ElementReference _scrollAreaRef;
    private ElementReference _viewportRef;
    private IJSObjectReference? _module;
    private IJSObjectReference? _scrollAreaInstance;
    private DotNetObjectReference<ScrollArea>? _dotNetRef;

    /// <summary>
    /// The content to render within the scrollable area.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// The type of scrollbar to show.
    /// Default is Auto (scrollbars visible when content overflows).
    /// </summary>
    [Parameter]
    public ScrollAreaType Type { get; set; } = ScrollAreaType.Auto;

    /// <summary>
    /// Controls the visibility delay of scrollbars in milliseconds.
    /// Only applies when Type is Scroll or Hover.
    /// Default is 600ms.
    /// </summary>
    [Parameter]
    public int ScrollHideDelay { get; set; } = 600;

    /// <summary>
    /// Whether to show the vertical scrollbar.
    /// Default is true.
    /// </summary>
    [Parameter]
    public bool ShowVerticalScrollbar { get; set; } = true;

    /// <summary>
    /// Whether to show the horizontal scrollbar.
    /// Default is false.
    /// </summary>
    [Parameter]
    public bool ShowHorizontalScrollbar { get; set; } = false;

    /// <summary>
    /// Whether to enable scroll shadows that indicate more content is available.
    /// Default is true.
    /// </summary>
    [Parameter]
    public bool EnableScrollShadows { get; set; } = true;

    /// <summary>
    /// Additional CSS classes to apply to the root element.
    /// </summary>
    [Parameter]
    public string? Class { get; set; }

    /// <summary>
    /// Additional attributes to apply to the root element.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && EnableScrollShadows)
        {
            try
            {
                _module = await JSRuntime.InvokeAsync<IJSObjectReference>(
                    "import", "./_content/BlazorUI.Components/js/scroll-area.js");

                _dotNetRef = DotNetObjectReference.Create(this);

                _scrollAreaInstance = await _module.InvokeAsync<IJSObjectReference>(
                    "initialize",
                    _scrollAreaRef,
                    _dotNetRef,
                    new { enableShadows = EnableScrollShadows });
            }
            catch
            {
                // Silently handle initialization errors
            }
        }
    }

    /// <summary>
    /// Invoked by JavaScript when scroll position changes.
    /// </summary>
    [JSInvokable]
    public Task OnScrollPositionChanged(ScrollPositionInfo info)
    {
        // This can be used to trigger state changes if needed
        // For now, shadows are handled purely via CSS and data attributes
        return Task.CompletedTask;
    }

    private string GetOverflowStyle()
    {
        return Type switch
        {
            ScrollAreaType.Always => "overflow: scroll;",
            ScrollAreaType.Scroll => "overflow: auto;",
            ScrollAreaType.Hover => "overflow: hidden;",  // JS would toggle this on hover
            _ => "overflow: auto;"  // Auto - browser default behavior
        };
    }

    private Dictionary<string, object> GetRootAttributes()
    {
        var baseClass = "relative overflow-hidden";
        var classValue = string.IsNullOrEmpty(Class) ? baseClass : $"{baseClass} {Class}";

        var attributes = new Dictionary<string, object> { ["class"] = classValue };

        if (AdditionalAttributes != null)
        {
            foreach (var kvp in AdditionalAttributes.Where(kvp => kvp.Key != "class"))
            {
                attributes[kvp.Key] = kvp.Value;
            }
        }

        return attributes;
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (_module != null && _scrollAreaInstance != null)
            {
                await _module.InvokeVoidAsync("dispose", _scrollAreaInstance);
            }

            if (_scrollAreaInstance != null)
            {
                await _scrollAreaInstance.DisposeAsync();
            }

            if (_module != null)
            {
                await _module.DisposeAsync();
            }

            _dotNetRef?.Dispose();
        }
        catch
        {
            // Silently handle disposal errors
        }
    }

    public class ScrollPositionInfo
    {
        public bool CanScrollTop { get; set; }
        public bool CanScrollBottom { get; set; }
        public bool CanScrollLeft { get; set; }
        public bool CanScrollRight { get; set; }
        public double ScrollTop { get; set; }
        public double ScrollLeft { get; set; }
    }
}

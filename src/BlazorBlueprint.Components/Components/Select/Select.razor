@typeparam TValue
@namespace BlazorBlueprint.Components.Select
@using BlazorBlueprint.Primitives.Select
@using Microsoft.AspNetCore.Components.Forms
@using System.Linq.Expressions
@attribute [CascadingTypeParameter(nameof(TValue))]

@* Styled Select wrapper around Select *@
<BlazorBlueprint.Primitives.Select.Select TValue="TValue"
                 Value="@Value"
                 ValueChanged="@HandleValueChanged"
                 @bind-Open="IsOpen"
                 Disabled="Disabled"
                 DisplayTextSelector="@DisplayTextSelector"
                 class="@CssClass">
    @ChildContent
</BlazorBlueprint.Primitives.Select.Select>

@code {
    private FieldIdentifier _fieldIdentifier;
    private EditContext? _editContext;

    /// <summary>
    /// Gets or sets the cascaded EditContext from a parent EditForm.
    /// </summary>
    [CascadingParameter]
    private EditContext? CascadedEditContext { get; set; }
    /// <summary>
    /// Gets or sets the currently selected value.
    /// </summary>
    [Parameter]
    public TValue? Value { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked when the selected value changes.
    /// </summary>
    [Parameter]
    public EventCallback<TValue?> ValueChanged { get; set; }

    /// <summary>
    /// Gets or sets an expression that identifies the bound value.
    /// </summary>
    [Parameter]
    public Expression<Func<TValue?>>? ValueExpression { get; set; }

    /// <summary>
    /// Gets or sets whether the select is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Gets or sets whether the dropdown is open (controlled mode).
    /// </summary>
    [Parameter]
    public bool? Open { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked when the open state changes.
    /// </summary>
    [Parameter]
    public EventCallback<bool> OpenChanged { get; set; }

    /// <summary>
    /// Gets or sets additional CSS classes to apply to the select container.
    /// </summary>
    [Parameter]
    public string? Class { get; set; }

    /// <summary>
    /// Optional function to derive display text from the selected value.
    /// Use this when you have a pre-selected value and want to show its display text
    /// without waiting for the dropdown items to render and register.
    /// This keeps display text in sync automatically when the value changes.
    /// </summary>
    [Parameter]
    public Func<TValue, string>? DisplayTextSelector { get; set; }

    /// <summary>
    /// Gets or sets the content to be rendered inside the select component.
    /// Should contain SelectTrigger and SelectContent components.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    private bool IsOpen { get; set; }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        if (CascadedEditContext != null && ValueExpression != null)
        {
            _editContext = CascadedEditContext;
            _fieldIdentifier = FieldIdentifier.Create(ValueExpression);
        }
    }

    private async Task HandleValueChanged(TValue? value)
    {
        Value = value;
        await ValueChanged.InvokeAsync(value);

        if (_editContext != null && ValueExpression != null && _fieldIdentifier.FieldName != null)
        {
            _editContext.NotifyFieldChanged(_fieldIdentifier);
        }
    }

    /// <summary>
    /// Gets the computed CSS classes for the select container.
    /// </summary>
    private string CssClass => ClassNames.cn("relative", Class);
}
